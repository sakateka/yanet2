syntax = "proto3";

package aclpb;

import "common/commonpb/target.proto";

option go_package = "github.com/yanet-platform/yanet2/modules/"
		    "acl/controlplane/aclpb;aclpb";

service ACLService {
	// Updates the complete ACL configuration with a new set of rules
	rpc UpdateConfig(UpdateConfigRequest) returns (UpdateConfigResponse);
	// Allows to delete acl config if it is not referenced
	// by any pipeline.
	rpc DeleteConfig(DeleteConfigRequest) returns (DeleteConfigResponse);
	// Show specific ACL configuration
	rpc ShowConfig(ShowConfigRequest) returns (ShowConfigResponse);
	// List all ACL configurations across instances
	rpc ListConfigs(ListConfigsRequest) returns (ListConfigsResponse);

	// Updates fwstate config inside ACL configuration with a new set of
	// rules
	rpc UpdateFWStateConfig(UpdateFWStateConfigRequest)
		returns (UpdateFWStateConfigResponse);
}

message UpdateConfigRequest {
	commonpb.TargetModule target = 1;
	repeated Rule rules = 2;
}

message UpdateConfigResponse {
}

message ShowConfigRequest {
	commonpb.TargetModule target = 1;
}

message ShowConfigResponse {
	commonpb.TargetModule target = 1;
	repeated Rule rules = 2;
	MapConfig fwstate_map = 3;
	SyncConfig fwstate_sync = 4;
}

message Rule {
	repeated IPNet srcs = 1;
	repeated IPNet dsts = 2;
	repeated PortRange src_port_ranges = 3;
	repeated PortRange dst_port_ranges = 4;
	// List of network device names where this rule applies
	repeated string devices = 5;
	repeated VlanRange vlan_ranges = 6;
	// List of protocol ranges to match
	// Can match specific protocols or protocol+flag combinations
	repeated ProtoRange proto_ranges = 7;
	bool keep_state = 8;
	// For hitcount; pass and deny only
	string counter = 9;

	// Action to take when traffic matches the filter
	ActionKind action = 10;
}

message IPNet {
	// IP address in network byte order
	// 4 bytes for IPv4, 16 bytes for IPv6
	bytes addr = 1;
	// Network mask
	bytes mask = 2;
}

// Represents a TCP/UDP port range [from; to]
message PortRange {
	uint32 from = 1;
	uint32 to = 2;
}

// Represents a protocol number range [from; to]
// For transport protocols, upper byte may contain flag bits
message ProtoRange {
	uint32 from = 1;
	uint32 to = 2;
}

message VlanRange {
	uint32 from = 1;
	uint32 to = 2;
}

// Defines possible actions for matched traffic
enum ActionKind {
	ACTION_KIND_PASS = 0;
	ACTION_KIND_DENY = 1;
	ACTION_KIND_COUNT = 2;
	ACTION_KIND_CHECK_STATE = 3;
	ACTION_KIND_CREATE_STATE = 4;
}

// Delete config with specified name.
message DeleteConfigRequest {
	// Specifies module name and
	// dataplane instance of acl agent to delete.
	commonpb.TargetModule target = 1;
}

message DeleteConfigResponse {
	bool deleted = 1;
}

message ListConfigsRequest {
}

message ListConfigsResponse {
	repeated string configs = 1;
}

//////////////////////////////////////////////////////////////////////////////
// fwstate proto definitions

message UpdateFWStateConfigRequest {
	commonpb.TargetModule target = 1;
	MapConfig map_config = 2;
	SyncConfig sync_config = 3;
}

message UpdateFWStateConfigResponse {
}

// Map configuration for fwstate
message MapConfig {
	uint32 index_size = 1;
	uint32 extra_bucket_count = 2;
}

// Firewall state synchronization configuration
message SyncConfig {
	bytes src_addr = 1;	      // IPv6 source address (16 bytes);
	bytes dst_ether = 2;	      // Destination MAC address (6 bytes);
	bytes dst_addr_multicast = 3; // Multicast IPv6 address (16 bytes);
	uint32 port_multicast = 4;    // Multicast port;
	bytes dst_addr_unicast = 5;   // Unicast IPv6 address (16 bytes);
	uint32 port_unicast = 6;      // Unicast port;

	// Connection timeouts
	uint64 tcp_syn_ack = 7; // TCP SYN-ACK timeout in nanoseconds;
	uint64 tcp_syn = 8;	// TCP SYN timeout in nanoseconds;
	uint64 tcp_fin = 9;	// TCP FIN timeout in nanoseconds;
	uint64 tcp = 10;	// TCP established timeout in nanoseconds;
	uint64 udp = 11;	// UDP timeout in nanoseconds;
	uint64 default = 12;	// Default timeout in nanoseconds;
}
