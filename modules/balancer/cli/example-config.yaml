# Example Balancer Configuration
# This demonstrates all features of the new YAML format

# Packet processing configuration
packet_handler:
  # Virtual services list
  vs:
    # HTTP service with SOURCE_HASH scheduler
    # Demonstrates: flexible scheduler names, CIDR notation, multiple reals
    - addr: "192.0.2.1"
      port: 80
      proto: TCP  # Accepts: TCP, tcp
      scheduler: SOURCE_HASH  # Accepts: SOURCE_HASH, source_hash, SH, sh
      flags:
        gre: false
        fix_mss: true
        ops: false
        pure_l3: false
        wlc: false  # Dynamic weight adjustment disabled
      # CIDR notation for allowed sources
      allowed_srcs:
        - "10.0.0.0/8"
        - "172.16.0.0/12"
        - "192.168.0.0/16"
      reals:
        - ip: "10.1.1.1"
          port: 0  # Reserved for future use
          weight: 100
          src_addr: "192.0.2.1"
          src_mask: "255.255.255.255"
        - ip: "10.1.1.2"
          port: 0
          weight: 50
          src_addr: "192.0.2.1"
          src_mask: "255.255.255.255"
      peers:
        - "192.0.2.10"
        - "192.0.2.11"

    # HTTPS service with ROUND_ROBIN and WLC
    # Demonstrates: lowercase proto, WLC flag, allow all sources
    - addr: "192.0.2.2"
      port: 443
      proto: tcp  # Lowercase also accepted
      scheduler: round_robin  # Accepts: ROUND_ROBIN, round_robin, RR, rr
      flags:
        gre: false
        fix_mss: true
        ops: false
        pure_l3: false
        wlc: true  # Enable dynamic weight adjustment
      # Allow all IPv4 sources
      allowed_srcs:
        - "0.0.0.0/0"
      reals:
        - ip: "10.2.1.1"
          port: 0
          weight: 100
          src_addr: "192.0.2.2"
          src_mask: "255.255.255.255"
        - ip: "10.2.1.2"
          port: 0
          weight: 100
          src_addr: "192.0.2.2"
          src_mask: "255.255.255.255"
        - ip: "10.2.1.3"
          port: 0
          weight: 50
          src_addr: "192.0.2.2"
          src_mask: "255.255.255.255"
      peers:
        - "192.0.2.10"

    # UDP DNS service with OPS mode
    # Demonstrates: short scheduler name, empty allowed_srcs (allow none)
    - addr: "192.0.2.4"
      port: 53
      proto: UDP
      scheduler: SH  # Short form
      flags:
        gre: false
        fix_mss: false
        ops: true  # One Packet Scheduler - no session tracking
        pure_l3: false
        wlc: false
      # Empty = allow NONE (reject all traffic)
      # Useful for maintenance mode or testing
      allowed_srcs: []
      reals:
        - ip: "10.4.1.1"
          port: 0
          weight: 1
          src_addr: "192.0.2.4"
          src_mask: "255.255.255.255"
        - ip: "10.4.1.2"
          port: 0
          weight: 1
          src_addr: "192.0.2.4"
          src_mask: "255.255.255.255"
      peers: []

    # Pure L3 service (matches all ports)
    # Demonstrates: pure_l3 mode, port must be 0
    - addr: "192.0.2.3"
      port: 0  # MUST be 0 for pure_l3 mode
      proto: tcp
      scheduler: sh  # Short form lowercase
      flags:
        gre: false
        fix_mss: false
        ops: false
        pure_l3: true  # Matches ALL traffic to this IP regardless of port
        wlc: false
      allowed_srcs:
        - "10.0.0.0/8"
      reals:
        - ip: "10.3.1.1"
          port: 0
          weight: 1
          src_addr: "192.0.2.3"
          src_mask: "255.255.255.255"
      peers: []

    # IPv6 service
    # Demonstrates: IPv6 addresses, single host allowed source
    - addr: "2001:db8::1"
      port: 443
      proto: TCP
      scheduler: RR
      flags:
        gre: false
        fix_mss: true
        ops: false
        pure_l3: false
        wlc: false
      # Allow single IPv6 host
      allowed_srcs:
        - "2001:db8:1::42/128"
      reals:
        - ip: "2001:db8:100::1"
          port: 0
          weight: 100
          src_addr: "2001:db8::1"
          src_mask: "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"
      peers: []

  # Source addresses for encapsulation
  source_address_v4: "192.0.2.1"
  source_address_v6: "2001:db8::1"
  
  # Addresses for decapsulation (return traffic)
  decap_addresses:
    - "192.0.2.1"
    - "2001:db8::1"
  
  # Session timeouts (in seconds)
  sessions_timeouts:
    tcp_syn_ack: 10
    tcp_syn: 10
    tcp_fin: 10
    tcp: 60
    udp: 30
    default: 60

# State management configuration
state:
  # Session table configuration
  session_table:
    capacity: 1000000  # Maximum concurrent sessions
    max_load_factor: 0.75  # Trigger resize at 75% capacity
  
  # WLC (Weighted Least Connections) configuration
  # Used when vs.flags.wlc = true
  wlc:
    power: 10  # Adjustment aggressiveness
    max_weight: 1000  # Maximum weight after adjustment
  
  # Periodic refresh for session counting and weight adjustment
  # Set to 0 to disable
  refresh_period_ms: 5000  # 5 seconds
